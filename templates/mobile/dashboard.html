{% extends "base.html" %}
{% block title %}Mobile Erfassung – Erfassung{% endblock %}
{% block content %}
<section class="mobile-dashboard" aria-label="Mobile Zeiterfassung">
    <header class="mobile-dashboard__header">
        <div>
            <h1 class="mobile-dashboard__title">Mobile Erfassung</h1>
            <p class="mobile-dashboard__date">{{ today.strftime('%A, %d.%m.%Y') }}</p>
        </div>
        {% if active_entry %}
            <p class="mobile-dashboard__status">
                <span class="mobile-badge mobile-badge--running">Arbeitszeit läuft</span>
                seit {{ active_entry.start_time.strftime('%H:%M') }} Uhr
            </p>
        {% else %}
            <p class="mobile-dashboard__status mobile-dashboard__status--idle">
                <span class="mobile-badge">Bereit</span>
                Du kannst deine Arbeitszeit jetzt starten.
            </p>
        {% endif %}
    </header>

    <aside class="mobile-queue" id="mobile-queue-info" aria-live="polite" hidden>
        <span class="mobile-badge mobile-badge--queued" aria-hidden="true">⏳</span>
        <span id="mobile-sync-text">Offline-Buchungen werden synchronisiert.</span>
        <strong class="mobile-queue__count"><span id="mobile-pending-count">0</span>x</strong>
    </aside>

    <div class="mobile-feedback" id="mobile-feedback" role="status" aria-live="polite" hidden></div>

    {% set tab = active_tab or 'buchung' %}
    <nav class="mobile-tabs" role="tablist" aria-label="Bereiche">
        <a
            href="{{ tab_urls.buchung }}#buchung"
            class="mobile-tab {% if tab == 'buchung' %}is-active{% endif %}"
            data-tab="buchung"
            id="mobile-tab-buchung"
            aria-controls="mobile-panel-buchung"
            aria-selected="{{ 'true' if tab == 'buchung' else 'false' }}"
            role="tab"
        >Buchung</a>
        <a
            href="{{ tab_urls.uebersicht }}#uebersicht"
            class="mobile-tab {% if tab == 'uebersicht' %}is-active{% endif %}"
            data-tab="uebersicht"
            id="mobile-tab-uebersicht"
            aria-controls="mobile-panel-uebersicht"
            aria-selected="{{ 'true' if tab == 'uebersicht' else 'false' }}"
            role="tab"
        >Übersicht</a>
        <a
            href="{{ tab_urls.salden }}#salden"
            class="mobile-tab {% if tab == 'salden' %}is-active{% endif %}"
            data-tab="salden"
            id="mobile-tab-salden"
            aria-controls="mobile-panel-salden"
            aria-selected="{{ 'true' if tab == 'salden' else 'false' }}"
            role="tab"
        >Salden</a>
    </nav>

    <div class="mobile-panels">
        <section class="mobile-panel {% if tab == 'buchung' %}is-active{% endif %}" id="mobile-panel-buchung" data-tab-panel="buchung" role="tabpanel" aria-labelledby="mobile-tab-buchung" {% if tab != 'buchung' %}hidden{% endif %}>
            <div class="mobile-card">
                <h2 class="mobile-card__title">Schnell stempeln</h2>
                {% if active_entry %}
                    <div class="mobile-card__section">
                        <p class="mobile-card__text">
                            Gestartet um {{ active_entry.start_time.strftime('%H:%M') }} Uhr.
                            {% if active_entry.company %}
                                Auftrag: <strong>{{ active_entry.company.name }}</strong>.
                            {% endif %}
                        </p>
                        <p class="mobile-card__text">Aktuelle Arbeitszeit: {{ active_entry.worked_minutes|format_minutes }} Std</p>
                        {% if active_entry.break_started_at %}
                            <p class="mobile-card__text">
                                <span class="mobile-badge mobile-badge--break">Pause läuft</span>
                                seit {{ active_entry.break_started_at.strftime('%H:%M') }} Uhr
                            </p>
                        {% else %}
                            <p class="mobile-card__text">Erfasste Pausen: {{ active_entry.total_break_minutes|format_minutes }} Std</p>
                        {% endif %}
                    </div>
                    <div class="mobile-action-grid">
                        <form method="post" action="/punch" data-offline="punch">
                            <input type="hidden" name="next_url" value="/mobile">
                            <input type="hidden" name="action" value="start_break">
                            <button type="submit" class="mobile-button ghost" {% if active_entry.break_started_at %}disabled{% endif %}>Pause starten</button>
                        </form>
                        <form method="post" action="/punch" data-offline="punch">
                            <input type="hidden" name="next_url" value="/mobile">
                            <input type="hidden" name="action" value="end_break">
                            <button type="submit" class="mobile-button ghost" {% if not active_entry.break_started_at %}disabled{% endif %}>Pause beenden</button>
                        </form>
                        {% if active_entry.company_id is not none %}
                            <form method="post" action="/punch" data-offline="punch">
                                <input type="hidden" name="next_url" value="/mobile">
                                <input type="hidden" name="action" value="end_company">
                                <button type="submit" class="mobile-button">Auftrag beenden</button>
                            </form>
                        {% endif %}
                        <form method="post" action="/punch" data-offline="punch">
                            <input type="hidden" name="next_url" value="/mobile">
                            <input type="hidden" name="action" value="end_work">
                            <button type="submit" class="mobile-button danger">Arbeitszeit beenden</button>
                        </form>
                    </div>
                {% else %}
                    <div class="mobile-card__section">
                        <p class="mobile-card__text">Beginne deine Arbeitszeit mit einem Tipp.</p>
                    </div>
                    <div class="mobile-action-grid">
                        <form method="post" action="/punch" data-offline="punch">
                            <input type="hidden" name="next_url" value="/mobile">
                            <input type="hidden" name="action" value="start_work">
                            <button type="submit" class="mobile-button primary">Arbeitszeit starten</button>
                        </form>
                        {% if companies or can_create_companies %}
                            <button type="button" class="mobile-button" data-open="mobile-order-modal">Auftrag starten</button>
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            {% if companies or can_create_companies %}
                <div class="modal" id="mobile-order-modal" aria-hidden="true" role="dialog" aria-modal="true">
                    <div class="modal__backdrop" data-close></div>
                    <div class="modal__dialog">
                        <button type="button" class="modal__close" data-close aria-label="Schließen">&times;</button>
                        <h3>Auftrag starten</h3>
                        <p class="modal__hint">Wähle eine Firma oder lege einen neuen Auftrag an.</p>
                        <form method="post" action="/punch" class="modal__form" data-offline="punch">
                            <input type="hidden" name="next_url" value="/mobile">
                            <input type="hidden" name="action" value="start_company">
                            {% if companies %}
                                <label>
                                    Firma auswählen
                                    <select name="company_id">
                                        <option value="">Firma wählen</option>
                                        {% for company in companies %}
                                            <option value="{{ company.id }}">{{ company.name }}</option>
                                        {% endfor %}
                                    </select>
                                </label>
                            {% endif %}
                            {% if can_create_companies %}
                                <label>
                                    Neue Firma anlegen
                                    <input type="text" name="new_company_name" placeholder="Name der neuen Firma">
                                </label>
                            {% endif %}
                            <label>
                                Kommentar (optional)
                                <input type="text" name="notes" placeholder="z. B. Projekt oder Kundenname">
                            </label>
                            <div class="modal__actions modal-action-bar">
                                <button type="button" class="button ghost modal-action" data-close>
                                    <span class="modal-action__icon" aria-hidden="true">✕</span>
                                    <span>Abbrechen</span>
                                </button>
                                <button type="submit" class="button modal-action">
                                    <span class="modal-action__icon" aria-hidden="true">▶</span>
                                    <span>Auftrag starten</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            {% endif %}

            <div class="mobile-card mobile-card--hint">
                <h2 class="mobile-card__title">Hinweis</h2>
                <p class="mobile-card__text">Nach 6 Stunden Arbeit mindestens 30 Minuten Pause einlegen, nach 9 Stunden mindestens 45 Minuten (ArbZG).</p>
            </div>
        </section>

        <section class="mobile-panel {% if tab == 'uebersicht' %}is-active{% endif %}" id="mobile-panel-uebersicht" data-tab-panel="uebersicht" role="tabpanel" aria-labelledby="mobile-tab-uebersicht" {% if tab != 'uebersicht' %}hidden{% endif %}>
            <div class="mobile-card mobile-card--overview">
                <div class="mobile-card__header">
                    <h2 class="mobile-card__title">Übersicht</h2>
                    <div class="mobile-segmented" role="group" aria-label="Darstellung wählen">
                        <a class="mobile-segmented__button {% if overview_mode == 'day' %}is-active{% endif %}" href="{{ request.url_for('mobile_dashboard') }}?overview=day&amp;date={{ overview_reference_date.isoformat() }}#uebersicht" {% if overview_mode == 'day' %}aria-current="page"{% endif %}>Tag</a>
                        <a class="mobile-segmented__button {% if overview_mode == 'week' %}is-active{% endif %}" href="{{ request.url_for('mobile_dashboard') }}?overview=week&amp;date={{ overview_reference_date.isoformat() }}#uebersicht" {% if overview_mode == 'week' %}aria-current="page"{% endif %}>Woche</a>
                    </div>
                </div>

                {% if overview_mode == 'week' %}
                    <div class="mobile-overview-nav" aria-label="Woche wechseln">
                        <a class="mobile-nav-button" href="{{ request.url_for('mobile_dashboard') }}?overview=week&amp;date={{ overview_week.prev.isoformat() }}#uebersicht" aria-label="Vorherige Woche">&lsaquo;</a>
                        <span class="mobile-overview-nav__label">
                            <strong>KW {{ overview_week.week_number }}</strong>
                            <small>{{ overview_week.week_start.strftime('%d.%m.') }} – {{ overview_week.week_end.strftime('%d.%m.%Y') }}</small>
                        </span>
                        {% if overview_week.can_go_next %}
                            <a class="mobile-nav-button" href="{{ request.url_for('mobile_dashboard') }}?overview=week&amp;date={{ overview_week.next.isoformat() }}#uebersicht" aria-label="Nächste Woche">&rsaquo;</a>
                        {% else %}
                            <span class="mobile-nav-button is-disabled" aria-hidden="true">&rsaquo;</span>
                        {% endif %}
                    </div>
                    <dl class="mobile-overview-summary">
                        <div>
                            <dt>Arbeitszeit</dt>
                            <dd>{{ overview_week.total_minutes|format_minutes }} Std</dd>
                        </div>
                        <div>
                            <dt>Soll</dt>
                            <dd>{{ overview_week.target_minutes|format_minutes }} Std</dd>
                        </div>
                        <div>
                            <dt>Saldo</dt>
                            <dd class="{% if overview_week.balance_minutes < 0 %}is-negative{% endif %}">{{ overview_week.balance_minutes|format_minutes }} Std</dd>
                        </div>
                        {% if overview_week.vacation_minutes %}
                            <div>
                                <dt>Urlaub</dt>
                                <dd>{{ overview_week.vacation_minutes|format_minutes }} Std</dd>
                            </div>
                        {% endif %}
                    </dl>
                    <ul class="mobile-week-list mobile-week-list--grid">
                        {% for day in overview_week.days %}
                            <li class="mobile-week-day {% if day.is_today %}is-today{% endif %}">
                                <span class="mobile-week-day__label">{{ day.date.strftime('%a %d.%m.') }}</span>
                                <span class="mobile-week-day__minutes">{{ day.minutes|format_minutes }} Std</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="mobile-overview-nav" aria-label="Tag wechseln">
                        <a class="mobile-nav-button" href="{{ request.url_for('mobile_dashboard') }}?overview=day&amp;date={{ overview_day.prev.isoformat() }}#uebersicht" aria-label="Vorheriger Tag">&lsaquo;</a>
                        <span class="mobile-overview-nav__label">
                            <strong>{{ overview_day.date.strftime('%A, %d.%m.%Y') }}</strong>
                            {% if overview_day.is_today %}
                                <small>(Heute)</small>
                            {% endif %}
                        </span>
                        {% if overview_day.can_go_next %}
                            <a class="mobile-nav-button" href="{{ request.url_for('mobile_dashboard') }}?overview=day&amp;date={{ overview_day.next.isoformat() }}#uebersicht" aria-label="Nächster Tag">&rsaquo;</a>
                        {% else %}
                            <span class="mobile-nav-button is-disabled" aria-hidden="true">&rsaquo;</span>
                        {% endif %}
                    </div>
                    <dl class="mobile-overview-summary">
                        <div>
                            <dt>Arbeitszeit</dt>
                            <dd>{{ overview_day.total_minutes|format_minutes }} Std</dd>
                        </div>
                        <div>
                            <dt>Soll</dt>
                            <dd>{{ overview_day.target_minutes|format_minutes }} Std</dd>
                        </div>
                        <div>
                            <dt>Saldo</dt>
                            <dd class="{% if overview_day.balance_minutes < 0 %}is-negative{% endif %}">{{ overview_day.balance_minutes|format_minutes }} Std</dd>
                        </div>
                    </dl>
                    {% if overview_day.entries %}
                        <ul class="mobile-entry-list mobile-entry-list--compact">
                            {% for entry in overview_day.entries %}
                                <li class="mobile-entry {% if entry.is_open %}is-active{% endif %}">
                                    <div class="mobile-entry__times">
                                        <strong>{{ entry.start_time.strftime('%H:%M') }}</strong>
                                        <span>–</span>
                                        <strong>
                                            {% if entry.is_open %}
                                                läuft
                                            {% elif entry.end_time %}
                                                {{ entry.end_time.strftime('%H:%M') }}
                                            {% else %}
                                                –
                                            {% endif %}
                                        </strong>
                                    </div>
                                    <div class="mobile-entry__meta">
                                        <span>Arbeitszeit {{ entry.worked_minutes|format_minutes }} Std</span>
                                        {% if entry.total_break_minutes %}
                                            <span>Pausen {{ entry.total_break_minutes|format_minutes }} Std</span>
                                        {% endif %}
                                        {% if entry.company %}
                                            <span>{{ entry.company.name }}</span>
                                        {% endif %}
                                        {% if entry.notes %}
                                            <span class="mobile-entry__notes">{{ entry.notes }}</span>
                                        {% endif %}
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="mobile-empty-state">Für diesen Tag wurden noch keine Buchungen erfasst.</p>
                    {% endif %}
                {% endif %}
            </div>
        </section>

        <section class="mobile-panel {% if tab == 'salden' %}is-active{% endif %}" id="mobile-panel-salden" data-tab-panel="salden" role="tabpanel" aria-labelledby="mobile-tab-salden" {% if tab != 'salden' %}hidden{% endif %}>
            <div class="mobile-card">
                <h2 class="mobile-card__title">Monatswerte</h2>
                <dl class="mobile-stats-grid">
                    <div>
                        <dt>Ist</dt>
                        <dd>{{ (metrics.total_work_minutes + metrics.vacation_minutes)|format_minutes }} Std</dd>
                    </div>
                    <div>
                        <dt>Soll</dt>
                        <dd>{{ metrics.target_minutes|format_minutes }} Std</dd>
                    </div>
                    <div>
                        <dt>Überstunden</dt>
                        <dd>{{ metrics.total_overtime_minutes|format_minutes }} Std</dd>
                    </div>
                    <div>
                        <dt>Genommene Überstd.</dt>
                        <dd>{{ metrics.overtime_taken_minutes|format_minutes }} Std</dd>
                    </div>
                    <div>
                        <dt>Urlaub (Monat)</dt>
                        <dd>{{ metrics.vacation_minutes|format_minutes }} Std</dd>
                    </div>
                    {% if metrics.overtime_limit_minutes %}
                        <div>
                            <dt>Überstundenlimit</dt>
                            <dd>{{ metrics.overtime_limit_minutes|format_minutes }} Std</dd>
                        </div>
                        <div>
                            <dt>Restlimit</dt>
                            <dd>
                                {% if metrics.overtime_limit_exceeded %}
                                    Überschritten um {{ metrics.overtime_limit_excess_minutes|format_minutes }} Std
                                {% else %}
                                    {{ metrics.overtime_limit_remaining_minutes|format_minutes }} Std verfügbar
                                {% endif %}
                            </dd>
                        </div>
                    {% endif %}
                </dl>
            </div>
            <div class="mobile-card">
                <h2 class="mobile-card__title">Urlaubskonto</h2>
                <dl class="mobile-stats-grid">
                    <div>
                        <dt>Jahresurlaub</dt>
                        <dd>{{ metrics.vacation_summary.total_days|round(2) }} Tage</dd>
                    </div>
                    {% if metrics.vacation_summary.carryover_days > 0 %}
                        <div>
                            <dt>Übertrag</dt>
                            <dd>{{ metrics.vacation_summary.carryover_days|round(2) }} Tage</dd>
                        </div>
                    {% endif %}
                    <div>
                        <dt>Genommen</dt>
                        <dd>{{ metrics.vacation_summary.used_days|round(2) }} Tage</dd>
                    </div>
                    <div>
                        <dt>Geplant</dt>
                        <dd>{{ metrics.vacation_summary.planned_days|round(2) }} Tage</dd>
                    </div>
                    <div>
                        <dt>Rest</dt>
                        <dd>{{ metrics.vacation_summary.remaining_days|round(2) }} Tage</dd>
                    </div>
                </dl>
            </div>
        </section>
    </div>
</section>

{% block scripts %}
{{ super() }}
<script type="module" src="/static/mobile.js"></script>
{% endblock %}
{% endblock %}
