{% extends "base.html" %}
{% block title %}Administration – Erfassung{% endblock %}
{% block content %}
<section class="admin-grid">
    <section class="card">
        <h1>Gruppenverwaltung</h1>
        <table class="admin-table">
            <thead>
            <tr>
                <th>Bezeichnung</th>
                <th>Rolle</th>
                <th>Aktionen</th>
            </tr>
            </thead>
            <tbody>
            {% for group in groups %}
                <tr>
                    <td>
                        <form method="post" action="/admin/groups/{{ group.id }}/update" class="inline-form">
                            <input type="text" name="name" value="{{ group.name }}" required>
                            <label class="checkbox">
                                <input type="checkbox" name="is_admin" {% if group.is_admin %}checked{% endif %}>
                                Administrator
                            </label>
                            <button type="submit" class="button small">Speichern</button>
                        </form>
                    </td>
                    <td>{{ 'Administrator' if group.is_admin else 'Standard' }}</td>
                    <td>
                        <form method="post" action="/admin/groups/{{ group.id }}/delete" onsubmit="return confirm('Gruppe wirklich löschen? Zugeordnete Nutzer müssen vorher entfernt werden.');">
                            <button type="submit" class="button danger small">Löschen</button>
                        </form>
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="3">Keine Gruppen vorhanden.</td></tr>
            {% endfor %}
            </tbody>
        </table>
        <h2>Neue Gruppe anlegen</h2>
        <form method="post" action="/admin/groups/create" class="inline-form">
            <input type="text" name="name" placeholder="Gruppenname" required>
            <label class="checkbox">
                <input type="checkbox" name="is_admin">
                Administratorrechte
            </label>
            <button type="submit" class="button primary">Gruppe erstellen</button>
        </form>
    </section>

    <section class="card">
        <h1>Firmenverwaltung</h1>
        <table class="admin-table">
            <thead>
            <tr>
                <th>Name</th>
                <th>Beschreibung</th>
                <th>Aktionen</th>
            </tr>
            </thead>
            <tbody>
            {% for company in companies %}
                <tr>
                    <td colspan="3">
                        <form method="post" action="/admin/companies/{{ company.id }}/update" class="user-form">
                            <input type="text" name="name" value="{{ company.name }}" required>
                            <input type="text" name="description" value="{{ company.description }}" placeholder="Beschreibung">
                            <div class="form-actions">
                                <button type="submit" class="button small">Speichern</button>
                                <button type="submit" form="delete-company-{{ company.id }}" class="button danger small">Löschen</button>
                            </div>
                        </form>
                        <form id="delete-company-{{ company.id }}" method="post" action="/admin/companies/{{ company.id }}/delete" onsubmit="return confirm('Firma wirklich löschen? Es dürfen keine Buchungen mehr zugeordnet sein.');"></form>
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="3">Noch keine Firmen angelegt.</td></tr>
            {% endfor %}
            </tbody>
        </table>
        <h2>Neue Firma anlegen</h2>
        <form method="post" action="/admin/companies/create" class="user-form">
            <input type="text" name="name" placeholder="Firmenname" required>
            <input type="text" name="description" placeholder="Beschreibung (optional)">
            <button type="submit" class="button primary">Firma anlegen</button>
        </form>
    </section>
</section>

<section class="card">
    <h1>Benutzerverwaltung</h1>
    <table class="admin-table">
        <thead>
        <tr>
            <th>Name</th>
            <th>Login-PIN</th>
            <th>Email</th>
            <th>Gruppe</th>
            <th>Standardzeit</th>
            <th>Aktionen</th>
        </tr>
        </thead>
        <tbody>
        {% for item in users %}
            <tr>
                <td colspan="6">
                    <form method="post" action="/admin/users/{{ item.id }}/update" class="user-form">
                        <input type="text" name="username" value="{{ item.username }}" required>
                        <input type="text" name="full_name" value="{{ item.full_name }}" required>
                        <input type="email" name="email" value="{{ item.email }}" required>
                        <input type="text" name="pin_code" value="{{ item.pin_code }}" pattern="\d{4}" maxlength="4" required>
                        <input type="number" name="standard_daily_minutes" value="{{ item.standard_daily_minutes }}" min="1" step="1" required>
                        <select name="group_id">
                            <option value="">ohne Gruppe</option>
                            {% for group in groups %}
                                <option value="{{ group.id }}" {% if item.group and item.group.id == group.id %}selected{% endif %}>{{ group.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-actions">
                            <button type="submit" class="button small">Aktualisieren</button>
                            <button type="submit" form="delete-user-{{ item.id }}" class="button danger small">Löschen</button>
                        </div>
                    </form>
                    <form id="delete-user-{{ item.id }}" method="post" action="/admin/users/{{ item.id }}/delete" class="inline-form" onsubmit="return confirm('Benutzer wirklich löschen?');"></form>
                </td>
            </tr>
        {% else %}
            <tr><td colspan="6">Keine Benutzer vorhanden.</td></tr>
        {% endfor %}
        </tbody>
    </table>

    <h2>Neuen Benutzer anlegen</h2>
    <form method="post" action="/admin/users/create" class="user-form">
        <input type="text" name="username" placeholder="Loginname" required>
        <input type="text" name="full_name" placeholder="Anzeigename" required>
        <input type="email" name="email" placeholder="Email" required>
        <input type="text" name="pin_code" placeholder="4-stelliger PIN" pattern="\d{4}" maxlength="4" required>
        <input type="number" name="standard_daily_minutes" value="480" min="1" step="1" required>
        <select name="group_id">
            <option value="">ohne Gruppe</option>
            {% for group in groups %}
                <option value="{{ group.id }}">{{ group.name }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="button primary">Benutzer anlegen</button>
    </form>
</section>

<section class="card">
    <div class="card-header">
        <h1>Zeiterfassungen verwalten</h1>
        <form method="get" action="/admin" class="filter-bar">
            <label>
                Benutzer
                <select name="user">
                    <option value="">Alle Benutzer</option>
                    {% for item in users %}
                        <option value="{{ item.id }}" {% if selected_user_id == item.id %}selected{% endif %}>{{ item.full_name }}</option>
                    {% endfor %}
                </select>
            </label>
            <button type="submit" class="button small">Filtern</button>
            {% if selected_user_id %}
                <a class="button ghost small" href="/admin">Zurücksetzen</a>
            {% endif %}
        </form>
    </div>
    <div class="table-scroll">
        <table class="admin-table">
            <thead>
            <tr>
                <th>Mitarbeiter</th>
                <th>Datum</th>
                <th>Start</th>
                <th>Ende</th>
                <th>Pause</th>
                <th>Firma</th>
                <th>Kommentar</th>
                <th>Aktionen</th>
            </tr>
            </thead>
            <tbody>
            {% for entry in time_entries %}
                <tr>
                    <td colspan="8">
                        <form method="post" action="/admin/time-entries/{{ entry.id }}/update" class="time-entry-form">
                            <input type="hidden" name="redirect_user" value="{{ selected_user_id or '' }}">
                            <select name="user_id">
                                {% for item in users %}
                                    <option value="{{ item.id }}" {% if entry.user and entry.user.id == item.id %}selected{% endif %}>{{ item.full_name }}</option>
                                {% endfor %}
                            </select>
                            <input type="date" name="work_date" value="{{ entry.work_date.strftime('%Y-%m-%d') }}" required>
                            <input type="time" name="start_time" value="{{ entry.start_time.strftime('%H:%M') }}" required>
                            <input type="time" name="end_time" value="{{ entry.end_time.strftime('%H:%M') }}" required>
                            <input type="number" name="break_minutes" value="{{ entry.break_minutes }}" min="0">
                            <select name="company_id">
                                <option value="">– keine –</option>
                                {% for company in companies %}
                                    <option value="{{ company.id }}" {% if entry.company and entry.company.id == company.id %}selected{% endif %}>{{ company.name }}</option>
                                {% endfor %}
                            </select>
                            <input type="text" name="notes" value="{{ entry.notes }}" placeholder="Kommentar">
                            <div class="form-actions">
                                <button type="submit" class="button small">Speichern</button>
                                <button type="submit" form="delete-entry-{{ entry.id }}" class="button danger small">Löschen</button>
                            </div>
                        </form>
                        <form id="delete-entry-{{ entry.id }}" method="post" action="/admin/time-entries/{{ entry.id }}/delete" onsubmit="return confirm('Zeitbuchung wirklich löschen?');">
                            <input type="hidden" name="redirect_user" value="{{ selected_user_id or '' }}">
                        </form>
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="8">Keine Zeitbuchungen vorhanden.</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}
