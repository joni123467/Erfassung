{% extends "base.html" %}
{% block title %}Dashboard – Erfassung{% endblock %}
{% block content %}
{% if message %}
    <div class="alert alert-success">{{ message }}</div>
{% endif %}
{% if error %}
    <div class="alert alert-danger">{{ error }}</div>
{% endif %}

<section class="metrics">
    <h1>Arbeitszeitübersicht – {{ metrics_month.strftime('%m/%Y') }}</h1>
    <div class="metric-grid">
        <article>
            <h2>Ist-Stunden (Monat)</h2>
            <p>{{ (metrics.total_work_minutes / 60)|round(2) }} Stunden</p>
        </article>
        <article>
            <h2>Überstunden (Monat)</h2>
            <p>{{ (metrics.total_overtime_minutes / 60)|round(2) }} Stunden</p>
        </article>
        <article>
            <h2>Sollstunden (Monat)</h2>
            <p>{{ (metrics.target_minutes / 60)|round(2) }} Stunden</p>
        </article>
        <article>
            <h2>Offene Urlaubsanträge</h2>
            <p>{{ metrics.pending_vacations }}</p>
        </article>
    </div>
</section>

<section class="card">
    <h2>Schnell stempeln</h2>
    {% if active_entry %}
        <div class="punch-status">
            <div>
                <p class="status-line">
                    <span class="status-badge running">Arbeitszeit läuft</span>
                    seit {{ active_entry.start_time.strftime('%H:%M') }} Uhr am {{ active_entry.work_date.strftime('%d.%m.%Y') }}
                </p>
                {% if active_entry.company %}
                    <p class="status-line">Firma: {{ active_entry.company.name }}</p>
                {% endif %}
                <p class="status-line">Aktuelle Arbeitszeit: {{ (active_entry.worked_minutes / 60)|round(2) }} Stunden</p>
                {% if active_entry.break_started_at %}
                    <p class="status-line">
                        <span class="status-badge break">Pause</span>
                        seit {{ active_entry.break_started_at.strftime('%H:%M') }} Uhr
                    </p>
                {% else %}
                    <p class="status-line">Erfasste Pausen: {{ active_entry.total_break_minutes }} Minuten</p>
                {% endif %}
            </div>
        </div>
        <div class="punch-actions">
            <form method="post" action="/punch">
                <input type="hidden" name="next_url" value="/dashboard">
                <input type="hidden" name="action" value="start_break">
                <button type="submit" class="button ghost" {% if active_entry.break_started_at %}disabled{% endif %}>Pause starten</button>
            </form>
            <form method="post" action="/punch">
                <input type="hidden" name="next_url" value="/dashboard">
                <input type="hidden" name="action" value="end_break">
                <button type="submit" class="button ghost" {% if not active_entry.break_started_at %}disabled{% endif %}>Pause beenden</button>
            </form>
            {% if active_entry.company_id is not none %}
                <form method="post" action="/punch">
                    <input type="hidden" name="next_url" value="/dashboard">
                    <input type="hidden" name="action" value="end_company">
                    <button type="submit" class="button">Auftrag beenden</button>
                </form>
            {% endif %}
            <form method="post" action="/punch">
                <input type="hidden" name="next_url" value="/dashboard">
                <input type="hidden" name="action" value="end_work">
                <button type="submit" class="button danger">Arbeitszeit beenden</button>
            </form>
        </div>
        {% if companies %}
        <form method="post" action="/punch" class="punch-order">
            <input type="hidden" name="next_url" value="/dashboard">
            <div class="punch-order-fields">
                <label>
                    Auftrag starten
                    <select name="company_id" required>
                        <option value="" disabled selected>Firma wählen</option>
                        {% for company in companies %}
                            <option value="{{ company.id }}">{{ company.name }}</option>
                        {% endfor %}
                    </select>
                </label>
            </div>
            <button type="submit" name="action" value="start_company" class="button">Auftrag starten</button>
        </form>
        {% endif %}
    {% else %}
        <form method="post" action="/punch" class="punch-start">
            <input type="hidden" name="next_url" value="/dashboard">
            <label>
                Firma auswählen
                <select name="company_id">
                    <option value="">Allgemeine Arbeitszeit</option>
                    {% for company in companies %}
                        <option value="{{ company.id }}">{{ company.name }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                Kommentar (optional)
                <input type="text" name="notes" placeholder="z. B. Projekt oder Kundenname">
            </label>
            <div class="punch-start-buttons">
                <button type="submit" name="action" value="start_work" class="button primary">Kommen</button>
                <button type="submit" name="action" value="start_company" class="button">Auftrag starten</button>
            </div>
        </form>
    {% endif %}
</section>

<section class="card">
    <h2>Manuelle Buchung</h2>
    <form method="post" action="/time" class="form-grid">
        <input type="hidden" name="next_url" value="/dashboard">
        <label>
            Datum
            <input type="date" name="work_date" value="{{ now().strftime('%Y-%m-%d') }}" required>
        </label>
        <label>
            Startzeit
            <input type="time" name="start_time" required>
        </label>
        <label>
            Endzeit
            <input type="time" name="end_time" required>
        </label>
        <label>
            Pause (Minuten)
            <input type="number" name="break_minutes" value="0" min="0">
        </label>
        <label>
            Firma
            <select name="company_id">
                <option value="">– auswählen –</option>
                {% for company in companies %}
                    <option value="{{ company.id }}">{{ company.name }}</option>
                {% endfor %}
            </select>
        </label>
        <label class="full-width">
            Kommentar
            <textarea name="notes" rows="2" placeholder="z. B. Projekt oder Kunde"></textarea>
        </label>
        <button type="submit" class="button primary full-width">Zeitbuchung speichern</button>
    </form>
    <p class="form-hint">Manuelle Buchungen werden erst nach Freigabe durch die Administration wirksam.</p>
    <p class="form-hint">Werden keine Pausen gestempelt, werden automatisch gesetzliche Pausen von der Arbeitszeit abgezogen.</p>
</section>

<section class="card">
    <h2>Feiertage ({{ holiday_region_label }})</h2>
    <ul>
        {% for holiday in holidays %}
            <li>{{ holiday.date.strftime('%d.%m.%Y') }} – {{ holiday.name }}</li>
        {% else %}
            <li>Keine Feiertage eingetragen. Bitte Synchronisation ausführen.</li>
        {% endfor %}
    </ul>
    <p><a class="button" href="/records">Zu meinen Buchungen wechseln</a></p>
</section>
{% endblock %}
