{% extends "base.html" %}
{% block title %}Dashboard – Erfassung{% endblock %}
{% block content %}
{% if message %}
    <div class="alert alert-success">{{ message }}</div>
{% endif %}
{% if error %}
    <div class="alert alert-danger">{{ error }}</div>
{% endif %}

{% set ist_minutes = metrics.total_work_minutes %}
{% set soll_minutes = metrics.target_minutes %}
{% set overtime_taken_minutes = metrics.overtime_taken_minutes %}
{% set diff_minutes = ist_minutes + overtime_taken_minutes - soll_minutes %}
{% set diff_class = 'is-positive' if diff_minutes >= 0 else 'is-negative' %}
<section class="dashboard-summary">
    <div class="dashboard-summary__info">
        <h1>Arbeitszeiten</h1>
        <p class="dashboard-summary__month">Übersicht für {{ metrics_month.strftime('%m/%Y') }}</p>
        <div class="dashboard-summary__hint">
            <strong>Hinweis (Arbeitsschutz):</strong>
            Nach 6 Stunden Arbeit sind mindestens 30 Minuten Pause erforderlich,
            nach 9 Stunden mindestens 45 Minuten (ArbZG). Bitte stempel deine Pause entsprechend.
        </div>
    </div>
    <aside class="dashboard-summary__card">
        <h2>Meine Soll-/Ist-Stunden</h2>
        <dl class="dashboard-summary__stats">
            <div>
                <dt>Aktueller Monat</dt>
                <dd>{{ metrics_month.strftime('%m/%Y') }}</dd>
            </div>
            <div>
                <dt>Monatliches Soll</dt>
                <dd>{{ soll_minutes|format_minutes }} Std</dd>
            </div>
            <div>
                <dt>Bisher geleistet (Ist)</dt>
                <dd>{{ ist_minutes|format_minutes }} Std</dd>
            </div>
            <div>
                <dt>Überstundenabbau</dt>
                <dd>{{ overtime_taken_minutes|format_minutes }} Std</dd>
            </div>
            <div class="dashboard-summary__diff {{ diff_class }}">
                <dt>Diff (Ist - Soll)</dt>
                <dd>{{ diff_minutes|format_minutes }} Std</dd>
            </div>
            {% if user.time_account_enabled %}
                <div>
                    <dt>Offene Minusstunden</dt>
                    <dd>{{ metrics.total_undertime_minutes|format_minutes }} Std</dd>
                </div>
            {% endif %}
        </dl>
        <p class="dashboard-summary__meta">
            {% if metrics.pending_vacations > 0 %}
                {{ metrics.pending_vacations }} offene Urlaubsanträge warten auf Freigabe.
            {% else %}
                Keine offenen Urlaubsanträge vorhanden.
            {% endif %}
        </p>
    </aside>
</section>

<section class="card">
    <h2>Schnell stempeln</h2>
    {% if active_entry %}
        <div class="punch-status">
            <div>
                <p class="status-line">
                    <span class="status-badge running">Arbeitszeit läuft</span>
                    seit {{ active_entry.start_time.strftime('%H:%M') }} Uhr am {{ active_entry.work_date.strftime('%d.%m.%Y') }}
                </p>
                {% if active_entry.company %}
                    <p class="status-line">Firma: {{ active_entry.company.name }}</p>
                {% endif %}
                <p class="status-line">Aktuelle Arbeitszeit: {{ active_entry.worked_minutes|format_minutes }} Stunden</p>
                {% if active_entry.break_started_at %}
                    <p class="status-line">
                        <span class="status-badge break">Pause</span>
                        seit {{ active_entry.break_started_at.strftime('%H:%M') }} Uhr
                    </p>
                {% else %}
                    <p class="status-line">Erfasste Pausen: {{ active_entry.total_break_minutes|format_minutes }} Std</p>
                {% endif %}
            </div>
        </div>
        <div class="punch-actions">
            <form method="post" action="/punch">
                <input type="hidden" name="next_url" value="/dashboard">
                <input type="hidden" name="action" value="start_break">
                <button type="submit" class="button ghost" {% if active_entry.break_started_at %}disabled{% endif %}>Pause starten</button>
            </form>
            <form method="post" action="/punch">
                <input type="hidden" name="next_url" value="/dashboard">
                <input type="hidden" name="action" value="end_break">
                <button type="submit" class="button ghost" {% if not active_entry.break_started_at %}disabled{% endif %}>Pause beenden</button>
            </form>
            {% if active_entry.company_id is not none %}
                <form method="post" action="/punch">
                    <input type="hidden" name="next_url" value="/dashboard">
                    <input type="hidden" name="action" value="end_company">
                    <button type="submit" class="button">Auftrag beenden</button>
                </form>
            {% endif %}
            {% if companies %}
                <button type="button" class="button" data-open="order-modal">Auftrag starten</button>
            {% endif %}
            <form method="post" action="/punch">
                <input type="hidden" name="next_url" value="/dashboard">
                <input type="hidden" name="action" value="end_work">
                <button type="submit" class="button danger">Arbeitszeit beenden</button>
            </form>
        </div>
    {% else %}
        <div class="punch-start-options">
            <form method="post" action="/punch" class="punch-start-quick">
                <input type="hidden" name="next_url" value="/dashboard">
                <input type="hidden" name="action" value="start_work">
                <button type="submit" class="button primary">Arbeitszeit starten</button>
            </form>
            {% if companies %}
            <button type="button" class="button ghost" data-open="order-modal">Auftrag starten</button>
            {% endif %}
        </div>
    {% endif %}
    {% if companies %}
    <div class="modal" id="order-modal" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="modal__backdrop" data-close></div>
        <div class="modal__dialog">
            <button type="button" class="modal__close" data-close aria-label="Schließen">&times;</button>
            <h3>Auftrag starten</h3>
            <p class="modal__hint">Wähle eine Firma aus und hinterlasse optional einen Kommentar.</p>
            <form method="post" action="/punch" class="modal__form">
                <input type="hidden" name="next_url" value="/dashboard">
                <input type="hidden" name="action" value="start_company">
                <label>
                    Firma auswählen
                    <select name="company_id" required>
                        <option value="" disabled selected>Firma wählen</option>
                        {% for company in companies %}
                            <option value="{{ company.id }}">{{ company.name }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label>
                    Kommentar (optional)
                    <input type="text" name="notes" placeholder="z. B. Projekt oder Kundenname">
                </label>
                <div class="modal__actions">
                    <button type="submit" class="button">Auftrag starten</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</section>

<section class="card">
    <h2>Manuelle Buchung</h2>
    <form method="post" action="/time" class="form-grid">
        <input type="hidden" name="next_url" value="/dashboard">
        <label>
            Datum
            <input type="date" name="work_date" value="{{ now().strftime('%Y-%m-%d') }}" required>
        </label>
        <label>
            Startzeit
            <input type="time" name="start_time" required>
        </label>
        <label>
            Endzeit
            <input type="time" name="end_time" required>
        </label>
        <label>
            Pause (Minuten)
            <input type="number" name="break_minutes" value="0" min="0">
        </label>
        <label>
            Firma
            <select name="company_id">
                <option value="">– auswählen –</option>
                {% for company in companies %}
                    <option value="{{ company.id }}">{{ company.name }}</option>
                {% endfor %}
            </select>
        </label>
        <label class="full-width">
            Kommentar
            <textarea name="notes" rows="2" placeholder="z. B. Projekt oder Kunde"></textarea>
        </label>
        <button type="submit" class="button primary full-width">Zeitbuchung speichern</button>
    </form>
    <p class="form-hint">Manuelle Buchungen werden erst nach Freigabe durch die Administration wirksam.</p>
    <p class="form-hint">Werden keine Pausen gestempelt, werden automatisch gesetzliche Pausen von der Arbeitszeit abgezogen.</p>
</section>

<section class="card">
    <h2>Feiertage ({{ holiday_region_label }})</h2>
    <ul>
        {% for holiday in holidays %}
            <li>{{ holiday.date.strftime('%d.%m.%Y') }} – {{ holiday.name }}</li>
        {% else %}
            <li>Keine Feiertage eingetragen. Bitte Synchronisation ausführen.</li>
        {% endfor %}
    </ul>
    <p><a class="button" href="/records">Zu meinen Buchungen wechseln</a></p>
</section>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('order-modal');
    if (!modal) {
        return;
    }
    const openers = document.querySelectorAll('[data-open="order-modal"]');
    const closeElements = modal.querySelectorAll('[data-close]');

    const setVisibility = (visible) => {
        if (visible) {
            modal.classList.add('is-visible');
            modal.setAttribute('aria-hidden', 'false');
            document.body.classList.add('modal-open');
            const firstInput = modal.querySelector('select, input, button');
            if (firstInput) {
                firstInput.focus();
            }
        } else {
            modal.classList.remove('is-visible');
            modal.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('modal-open');
        }
    };

    openers.forEach((button) => {
        button.addEventListener('click', () => setVisibility(true));
    });

    closeElements.forEach((element) => {
        element.addEventListener('click', () => setVisibility(false));
    });

    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && modal.classList.contains('is-visible')) {
            setVisibility(false);
        }
    });
});
</script>
{% endblock %}
