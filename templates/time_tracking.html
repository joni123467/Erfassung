{% extends "base.html" %}
{% block title %}Stempeluhr – Erfassung{% endblock %}
{% block content %}
{% if message %}
    <div class="alert alert-success">{{ message }}</div>
{% endif %}
{% if error %}
    <div class="alert alert-danger">{{ error }}</div>
{% endif %}

<section class="card">
    <h1>Arbeitszeit erfassen</h1>
    {% if active_entry %}
        <div class="punch-status">
            <div>
                <p class="status-line">
                    <span class="status-badge running">Arbeitszeit läuft</span>
                    seit {{ active_entry.start_time.strftime('%H:%M') }} Uhr am {{ active_entry.work_date.strftime('%d.%m.%Y') }}
                </p>
                {% if active_entry.company %}
                    <p class="status-line">Firma: {{ active_entry.company.name }}</p>
                {% endif %}
                <p class="status-line">Aktuelle Arbeitszeit: {{ (active_entry.worked_minutes / 60)|round(2) }} Stunden</p>
                {% if active_entry.break_started_at %}
                    <p class="status-line">
                        <span class="status-badge break">Pause</span>
                        seit {{ active_entry.break_started_at.strftime('%H:%M') }} Uhr
                    </p>
                {% else %}
                    <p class="status-line">Erfasste Pausen: {{ active_entry.total_break_minutes }} Minuten</p>
                {% endif %}
            </div>
        </div>
        <div class="punch-actions">
            <form method="post" action="/punch">
                <input type="hidden" name="next_url" value="/time">
                <input type="hidden" name="action" value="start_break">
                <button type="submit" class="button ghost" {% if active_entry.break_started_at %}disabled{% endif %}>Pause starten</button>
            </form>
            <form method="post" action="/punch">
                <input type="hidden" name="next_url" value="/time">
                <input type="hidden" name="action" value="end_break">
                <button type="submit" class="button ghost" {% if not active_entry.break_started_at %}disabled{% endif %}>Pause beenden</button>
            </form>
            <form method="post" action="/punch">
                <input type="hidden" name="next_url" value="/time">
                <input type="hidden" name="action" value="end_work">
                <button type="submit" class="button danger">Arbeitszeit beenden</button>
            </form>
        </div>
    {% else %}
        <form method="post" action="/punch" class="punch-start">
            <input type="hidden" name="next_url" value="/time">
            <label>
                Firma auswählen
                <select name="company_id">
                    <option value="">Allgemeine Arbeitszeit</option>
                    {% for company in companies %}
                        <option value="{{ company.id }}">{{ company.name }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                Kommentar (optional)
                <input type="text" name="notes" placeholder="z. B. Projekt oder Kundenname">
            </label>
            <div class="punch-start-buttons">
                <button type="submit" name="action" value="start_work" class="button primary">Kommen</button>
                <button type="submit" name="action" value="start_company" class="button">Auftrag starten</button>
            </div>
        </form>
    {% endif %}
</section>

<section class="card">
    <h2>Manuelle Buchung</h2>
    <form method="post" action="/time" class="form-grid">
        <input type="hidden" name="next_url" value="/time">
        <label>
            Datum
            <input type="date" name="work_date" required>
        </label>
        <label>
            Startzeit
            <input type="time" name="start_time" required>
        </label>
        <label>
            Endzeit
            <input type="time" name="end_time" required>
        </label>
        <label>
            Pausenminuten
            <input type="number" name="break_minutes" value="0" min="0">
        </label>
        <label>
            Firma
            <select name="company_id">
                <option value="">– auswählen –</option>
                {% for company in companies %}
                    <option value="{{ company.id }}">{{ company.name }}</option>
                {% endfor %}
            </select>
        </label>
        <label class="full-width">
            Kommentar
            <textarea name="notes" rows="2" placeholder="z. B. Projekt oder Kundentermin"></textarea>
        </label>
        <button type="submit" class="button primary full-width">Buchung speichern</button>
    </form>
</section>

<section>
    <h2>Letzte Buchungen</h2>
    <table>
        <thead>
        <tr>
            <th>Datum</th>
            <th>Firma</th>
            <th>Start</th>
            <th>Ende</th>
            <th>Pause</th>
            <th>Arbeitszeit</th>
            <th>Überstunden</th>
            <th>Kommentar</th>
        </tr>
        </thead>
        <tbody>
        {% for entry in entries %}
            <tr class="{% if entry.is_open %}open-entry{% endif %}">
                <td>{{ entry.work_date.strftime('%d.%m.%Y') }}</td>
                <td>{{ entry.company.name if entry.company else '–' }}</td>
                <td>{{ entry.start_time.strftime('%H:%M') }}</td>
                <td>{% if entry.is_open %}läuft{% else %}{{ entry.end_time.strftime('%H:%M') }}{% endif %}</td>
                <td>
                    {{ entry.total_break_minutes }} Min
                    {% if entry.break_started_at %}(Pause läuft){% endif %}
                </td>
                <td>{{ (entry.worked_minutes / 60)|round(2) }} Std</td>
                <td>{{ (entry.overtime_minutes / 60)|round(2) }} Std</td>
                <td>{{ entry.notes }}</td>
            </tr>
        {% else %}
            <tr><td colspan="8">Noch keine Buchungen vorhanden.</td></tr>
        {% endfor %}
        </tbody>
    </table>
</section>
{% endblock %}
